<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <title>Dashboard - Contractor Leads</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.v2.css') }}?v=5">
</head>
<body>
    <nav>
        <div class="nav-container">
            <a href="{{ url_for('index') }}">Home</a>
            <a href="{{ url_for('login') }}">Login</a>
            <a href="{{ url_for('signup') }}">Sign Up</a>
        </div>
    </nav>

    <main>
        <section class="dashboard">
            <h2>Your Leads Dashboard</h2>
            <table id="leads-table">
                <thead>
                    <tr>
                        <th data-sort="work_description">Job Name</th>
                        <th data-sort="address">Address</th>
                        <th data-sort="estimated_value">Job Dollar Amount</th>
                        <th data-sort="permit_type">Job Type</th>
                        <th>Date</th>
                    </tr>
                </thead>
                <tbody id="leads-body">
                    {% for lead in user_permits %}
                    <tr>
                        <td>{{ lead.work_description or 'N/A' }}</td>
                        <td>{{ lead.address or 'N/A' }}</td>
                        <td>{{ lead.estimated_value or 'N/A' }}</td>
                        <td>{{ lead.permit_type or 'N/A' }}</td>
                        <td>{{ lead.pull_time or 'N/A' }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            <div id="pagination"></div>
        </section>
    </main>

    <script>
        let leads = {{ user_permits|tojson }};
        let currentPage = 1;
        const itemsPerPage = 100;
        let sortColumn = null;
        let sortDirection = 'asc';

        function renderTable() {
            const start = (currentPage - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const pageLeads = leads.slice(start, end);

            const tbody = document.getElementById('leads-body');
            tbody.innerHTML = pageLeads.map(lead => `
                <tr>
                    <td>${lead.work_description || 'N/A'}</td>
                    <td>${lead.address || 'N/A'}</td>
                    <td>${lead.estimated_value || 'N/A'}</td>
                    <td>${lead.permit_type || 'N/A'}</td>
                    <td>${lead.pull_time || 'N/A'}</td>
                </tr>
            `).join('');
        }

        function renderPagination() {
            const totalPages = Math.ceil(leads.length / itemsPerPage);
            const pagination = document.getElementById('pagination');
            let html = '';
            for (let i = 1; i <= totalPages; i++) {
                html += `<button onclick="goToPage(${i})" ${i === currentPage ? 'class="active"' : ''}>${i}</button>`;
            }
            pagination.innerHTML = html;
        }

        function goToPage(page) {
            currentPage = page;
            renderTable();
            renderPagination();
        }

        function sortTable(column) {
            if (sortColumn === column) {
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                sortColumn = column;
                sortDirection = 'asc';
            }
            leads.sort((a, b) => {
                let aVal = a[column] || '';
                let bVal = b[column] || '';
                if (column === 'estimated_value') {
                    aVal = parseFloat(aVal) || 0;
                    bVal = parseFloat(bVal) || 0;
                }
                if (aVal < bVal) return sortDirection === 'asc' ? -1 : 1;
                if (aVal > bVal) return sortDirection === 'asc' ? 1 : -1;
                return 0;
            });
            currentPage = 1;
            renderTable();
            renderPagination();
        }

        document.querySelectorAll('th[data-sort]').forEach(th => {
            th.addEventListener('click', () => sortTable(th.dataset.sort));
        });

        renderTable();
        renderPagination();
    </script>
</body>
</html>
